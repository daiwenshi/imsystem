<!DOCTYPE >
<html html xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>客户群组</title>
		<link rel="stylesheet" th:href="@{/assets/SheZhi/lib/layui/css/layui.css}">
		<link rel="stylesheet" th:href="@{/assets/css/animate.min.css}">
		<style>
			#title{
				background-color: #FFFFFF;
			}
			
			.rank-ul{
				position: relative;
			}
			.rank-ul-li{
				position: absolute;
				width: 100%;
			}
			.rank-ul-li-leftDiv{
				position: absolute;
				left: 0;
			}
			.rank-ul-li-rightDiv{
				position: absolute;
				right: 10%;
			}
			
			::-webkit-scrollbar-track-piece{
				background-color:#fff;/*滚动条的背景颜色*/
				-webkit-border-radius:0;/*滚动条的圆角宽度*/
			}
			::-webkit-scrollbar{
				width:8px;/*滚动条的宽度*/
				height:8px;/*滚动条的高度*/
			}
			::-webkit-scrollbar-thumb:vertical{/*垂直滚动条的样式*/
				height:50px;
				background-color:#999;
				-webkit-border-radius:4px;
				outline:2px solid #fff;
				outline-offset:-2px;
				border:2px solid #fff;
			}
			::-webkit-scrollbar-thumb:hover{/*滚动条的hover样式*/
				height:50px;
				background-color:#9f9f9f;
				-webkit-border-radius:4px;
			}
			/* ::-webkit-scrollbar-thumb:horizontal{
				//水平滚动条的样式
				width:4px;
				background-color:#CCCCCC;
				-webkit-border-radius:6px;
			} */
		　　div::-webkit-scrollbar{

		　　　　width:8px;/*滚动条的宽度*/

		　　}
		</style>
	</head>
	<body>


		<div id="main" class="layui-field-box layui-bg-gray">


			<div class="layui-row layui-col-space15">
				
				<div class="layui-col-md4" style="min-height: 99vh;">
					<div class="layui-card" style="min-height: 90vh;">
						<div class="layui-card-header">客户群</div>
						<div class="layui-card-body">
							<div v-show="!bol" >
							
							<div  v-for="(item,index) in khlist">
							
									<div class="layui-collapse">
									<div class="layui-colla-item">
										<h2 id="title" class="layui-colla-title"><span v-text="item.name"></span>&nbsp;&nbsp; <span class="layui-btn layui-btn-xs" @click="addmessage(item.id)" >发送短信</span> <span class="layui-btn layui-btn-xs" @click="queryMessage(item.id)">查看历史</span></h2>
										<div class="layui-colla-content">
											<ul style=" max-height: 20rem;overflow-y:scroll;">
												
												<li v-for="(item1,index) in item.customerlist">
													<div class="layui-row">
														<div class="layui-col-md10">
															<span v-text="item1.column1"></span>&nbsp;&nbsp;<span>电话：</span><span v-text="item1.column2"></span>
														</div>
														<div class="layui-col-md2">
															<span class="layui-btn layui-btn-xs layui-btn-danger">删除</span>
														</div>
													</div>
													<hr class="hr15" />
												</li>
											</ul>
										</div>
									</div>
								
								</div>
								<hr class="hr15">
							
							</div>
							
							</div>
							
							<div v-show="bol">
								
								<form class="layui-form" action="">
								
									<div class="layui-form-item">
										<label class="layui-form-label">促销名称</label>
										<div class="layui-input-block">
											<input type="text" name="name" required lay-verify="required" placeholder="请输入名称" autocomplete="off" class="layui-input">
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">客户选择</label>
										<div class="layui-input-block">
											<div class="layui-collapse">
												<div class="layui-colla-item">
													<h2 id="title" class="layui-colla-title">点击浏览&nbsp;&nbsp;</h2>
													<div class="layui-colla-content">
														<input type="checkbox" v-for="(item,index) in customerlist"  class="cid"  :value="item.id" :title="item.name">
													</div>
												</div>
											</div>
										</div>
									</div>
									
								</form>
								
							</div>
							
							
							<div class="layui-row">
								<span v-show="!bol" class="layui-btn" @click="sh(true)">新增</span>
								<span v-show="bol"  lay-filter="add" lay-submit="" class="layui-btn">提交</span>
								<span v-show="bol" @click="sh(false)" class="layui-btn layui-bg-cyan">取消</span>
							</div>
							
						</div>
					</div>
				</div>
				
				<div class="layui-col-md3" style="min-height: 99vh; ">
					<div class="layui-card" style="min-height: 90vh; ">
						<div class="layui-card-header" >历史记录</div>
						
						<div class="layui-card-body">
							
							<div v-for="(item,index) in messagelist">
							
								<div class="layui-collapse">
									<div class="layui-colla-item">
										<h2 id="title" class="layui-colla-title">{{getFmtDate(item.time)}}&nbsp;&nbsp;</h2>
										<div class="layui-colla-content layui-text">
											
											<p>
												<span>发送时间：</span>&nbsp;&nbsp;<span>{{getFmtDate(item.time)}}</span>
											</p>
											<p>
												<span>内容：</span>&nbsp;&nbsp;
											</p>
											<p>
												<span>{{item.name}}</span>
											</p>
											
										</div>
									</div>
								</div>
								<hr class="hr15">
								
							</div>
						</div>

					</div>
				</div>
				
				<div class="layui-col-md5" style="min-height: 99vh; ">
					<div class="layui-card" style="min-height: 90vh; ">
						<div class="layui-card-header" >短信编辑</div>
						<div class="layui-card-body">
							<div class="layui-form">
								
								<div v-for="(item,index) in addmessagelist">
									<div class="layui-collapse">
										<div class="layui-colla-item">
											<h2 id="title" class="layui-colla-title">{{item.name}}&nbsp;&nbsp;</h2>
											<div class="layui-colla-content">
												<ul style="text-align: center; max-height: 20rem;overflow-y:scroll;">
													
													<li v-for="(item2,index) in item.customerlist">
														<span v-text="item2.column1"></span>&nbsp;&nbsp;<span>电话：</span><span v-text="item2.column2"></span>
														<hr class="hr15" />
													</li>
												</ul>
											</div>
										</div>
									</div>
									<hr class="hr15">
								</div>
								
								<div class="layui-form-item">
									<label >内容：</label>
								</div>
								<textarea id="textval" style="max-width: 100%;min-width: 100%;height: 15rem;" class="layui-textarea" placeholder="请编辑内容"></textarea>
								
								<hr class="hr15" >
								
								<div class="layui-row">
									<span class="layui-btn" @click="addshortmessage">确定</span>
								</div>
								
							</div>
							
				
						</div>
				
					</div>
				</div>
				
			</div>
		</div>

		</div>



		<script th:src="@{/assets/SheZhi/lib/layui/layui.js}"></script>
		<script th:src="@{/assets/js/jquery-1.8.3.js}"></script>
		<script th:src="@{/assets/js/vue.js}" type="text/javascript"></script>
		<script th:inline="javascript">
		var uid = JSON.parse(localStorage.user).id;
			var vue = new Vue({
				el: "#main",
				data: {
					bol:false,
					customerlist:[],
					khlist:[],
					messagelist:[],
					addmessagelist:[]
				},
				methods: {
					sh:function(bool){
						
						vue.bol = bool;
					},
					queryMessage:function (khid){
						$.ajax({
							url:[[@{/shortmessage/queryMessage}]],
							async:true,
							data:{
								'khid':khid
							},
							dataType:'json',
							type:'post',
							success:function(data){
								vue.messagelist = data;
								setTimeout(function(){
									 element.render();
								 },300)
							},
							error:function(xhr,type,errorThrown){
								
							}
						});
					},getFmtDate:function (input) {
					    var date = new Date(input);
					    var y = date.getFullYear();
					    var m = date.getMonth() + 1;
					    m = m < 10 ? ('0' + m) : m;
					    var d = date.getDate();
					    d = d < 10 ? ('0' + d) : d;
					    var h = date.getHours();
					    h = h < 10 ? ('0' + h) : h;
					    var minute = date.getMinutes();
					    var second = date.getSeconds();
					    minute = minute < 10 ? ('0' + minute) : minute;
					    second = second < 10 ? ('0' + second) : second;
					    return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;
					},
					addmessage:function(id){
						
						$.each(vue.khlist,(index,obj)=>{
							
							if(obj.id == id){
								vue.addmessagelist.push(obj);
							}
							
							
						});
						
						setTimeout(function(){
							 element.render();
						 },300)
						
					},
					addshortmessage:function(){
						
						let message = [];
						let phones = [];
						
						$.each(vue.addmessagelist,(index,item)=>{
							
							$.each(item.customerlist,(index,obj)=>{
								phones.push(obj.column2);
							});
							
							let mpojo = {
									'name':$("#textval").val(),
									'time':new Date(),
									'uid':uid,
									'khid':item.id,
									'phones':phones
							}
						
							message.push(mpojo);
							
							
							
						});
						$.ajax({
							url:[[@{/shortmessage/inertMessage}]],
							async:true,
							data:JSON.stringify(message),
							dataType:'json',
							type:'post',
							contentType:"application/json;charset=UTF-8",
							processData:false,
							success:function(data){
								
							},
							error:function(xhr,type,errorThrown){
								
							}
						});
						
						
					}
				}

			});
			
			function getcm(){
				
				vue.customerlist = [[${customerlist}]];
				vue.khlist = [[${khlist}]];
				 setTimeout(function(){
					 form.render("checkbox");
					 element.render();
				 },300)
			}
			
			var form;
			layui.use('form', function() {
				
				
				 form = layui.form;
				 //监听提交
				form.on('submit(add)',
				function() {
				    
					let customerlist = [];
					
					$(".cid").each(function(index,obj){
						
						if(obj.checked){
							
							let customer = {
									'cid':$(obj).val()
							};
							customerlist.push(customer);
						}
					});
					
					let shortmessage = {
						'name':$("[name=name]").val(),
						'customerlist':customerlist
					}
					
					$.ajax({
						url:[[@{/shortmessage/inertshortMessage}]],
						async:true,
						data:JSON.stringify(shortmessage),
						dataType:'json',
						type:'post',
						contentType:"application/json;charset=UTF-8",
						processData:false,
						success:function(data){
							 //发异步，把数据提交给php
						    layer.alert("增加成功", {
						        icon: 6
						    },function(){
						    	location.reload();
						    });
						},
						error:function(xhr,type,errorThrown){
							
						}
					});
					
				   
				    return false;
				});
				 
				 
				getcm();
	
			});
			var element;
			layui.use('element', function() {
				element = layui.element;
			});


		</script>
	</body>
</html>
