
<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- Favicon icon -->
    <title>发表公告页面</title>
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/font-awesome/css/font-awesome.min.css}">
    <link rel="apple-touch-icon" sizes="76x76" th:href="@{/assets/img/apple-icon.png}">
	<link rel="icon" type="image/png" sizes="96x96" th:href="@{/assets/img/favicon.png}">
	
	<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}"> 
	
    <link th:href="@{/assets/XiTong/css/bootstrap.min.css}" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/assets/XiTong/css/style.css}" rel="stylesheet">
    <!-- You can change the theme colors from here -->
    <link th:href="@{/assets/XiTong/css/blue.css}" id="theme" rel="stylesheet">
    
    <link rel="stylesheet" th:href="@{/assets/css/myStyle.css}">
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script th:src="@{https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js}"></script>
    <script th:src="@{https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js}"></script>
<![endif]-->
<style type="text/css">
	*{
		-webkit-user-select: none;
		font-size: 1.5rem;
	}
	[type="checkbox"]:not(:checked), [type="checkbox"]:checked{
		position: relative;
    	left: 0px;
    	opacity: 10;
	}
	h5 label{
		padding-top: 6px;
		margin-bottom: 0px;
		margin-right: 8px;
	}
	#searchZero{
		display: flex;
		flex: row;
		margin-right: 6%;
	}
	
	.checkbox_css{
        display: inline-block;
        box-sizing: content-box;
        width: 20px;
        height: 20px;
        -webkit-appearance: none;
        border-radius: 50%;
        background-color: #fff;
        border: 1px solid #d1d1d1;
    }
    .checkbox_css:checked{
        display: inline-block;
        box-sizing: content-box;
        width: 20px;
        height: 20px;
        -webkit-appearance: none;
        border-radius: 50%;
        background-position: -29px -91px;
        background-image: url("/assets/img/operation.png");
        background-repeat: no-repeat;
        background-size: 96px 640px;
        border: 1px solid #2685d2;
    }
	.table td, .table th{
		border-bottom: 1px solid rgb(2,143,208);
	}
	td img{
		width: 40%;
		height: 55%;
		border-radius: 50%;
	}
	a:hover{
		cursor: pointer;
	}
	#notice{
		width: 100%;
		height: 130px;
		padding: 0px 10px;
		text-indent: 35px;
	}
	/* 选择文件按钮样式 */
	#chooseFileDiv{
		position: absolute;
		bottom: 2px;
		opacity: 0.0;
		width: 81.97px;
		height: 33.24px;
	}
</style>
</head>
	<body>
	
		<input type="hidden" value="" id="uid"/>
	
		<div class="row elDocument"style="padding: 28px 20px;">
                    <!-- column -->
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-block">
                            	 <h5 class="card-subtitle " style="float: right;display: flex;flex-direction: row;">
                            	 	
                                	<input type="button" class="btn btn-primary" id="add" value="新增公告"/>
                                </h5>
                                <h4 class="card-title">发布公告</h4>
                               
                                <div class="table-responsive">
                                    <div class="form-group" style="display: flex;flex-direction: row;">
                                        <label class="col-md-2" style="display: inline-block;padding-top: 5px;">填写公告类型(必填)：</label>
                                        <div class="col-md-10">
                                            <input type="text" id="newsType" value="" class="form-control form-control-line" placeholder="假期/促销/..公告">
                                        </div>
                                    </div>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>选择</th>
                                                <th>门店名称</th>
                                                <th>门店地址</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(o,i) in storeList">
                                                <td>
													<label>
			                        					<input type="checkbox" class="checkbox_css check"/>
			                        					<input type="hidden" :value="o.id"/>
			                    					</label>
												</td>
                                                <td>{{o.name}}</td>
                                                <td>{{o.province}}/{{o.city}}/{{o.district}}/{{o.address}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <div id="conent">
                                    	<textarea placeholder="公告内容" id="notice"></textarea>
                                    	<div class="form-group">
	                                        <div class="col-sm-12">
					                            <input id="chooseFileDiv" type="file" multiple="multiple" value="" onchange="imgShow(this)">
	                                            <button class="btn btn-success">选择附件</button>
	                                            
	                                        </div>
	                                    </div>
                                    	
                                    </div>
                                    <div id="filesDiv"></div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
	</body>
	<script th:src="@{/assets/js/jquery.min.js}"></script>
 	<script th:src="@{/assets/vendor/jquery/jquery.js}"></script>
    <!-- Bootstrap tether Core JavaScript -->
    <script th:src="@{/assets/js/tether.min.js}"></script>
    <script th:src="@{/assets/js/bootstrap.min.js}"></script>
    <!-- slimscrollbar scrollbar JavaScript -->
    <script th:src="@{/assets/js/jquery.slimscroll.js}"></script>
    <!--Wave Effects -->
    <script th:src="@{/assets/js/waves.js}"></script>
    <!--Menu sidebar -->
    <script th:src="@{/assets/js/sidebarmenu.js}"></script>
    <!--stickey kit -->
    <script th:src="@{/assets/js/sticky-kit.min.js}"></script>
    <!--Custom JavaScript -->
    <script th:src="@{/assets/js/custom.min.js}"></script>
    <script th:src="@{/assets/js/vue.js}"></script>
   <script th:src="@{/assets/js/pageNumber.js}"></script>
	<script>
		var vue=new Vue({
			el:".elDocument",
			data:{
				storeList:"",
				user:{}
			}
		});
		
		var fileArr = [];
		var index = 0;
		
		/* 文件回显 */
		function imgShow(th){
			var list = th.files; 
	        for( var i = 0 ; i < list.length ; i++ ){ 
	           var file = th.files.item(i);
				if (!(/^image\/.*$/i.test(file.type))) {
					continue; //不是图片 就跳出这一次循环  
				}
				
				fileArr.push(th.files[i]);
				
				var freader = new FileReader();
				freader.readAsDataURL(file);
				freader.onload = function(e) {

					var div = $("<div style='margin-bottom:20px;'  class='img-div col-lg-2 text-center'><div class='imgmaindiv'><span title='删除' index='"
							+ index
							+ "' onclick='delImg(this)' class='glyphicon glyphicon-remove delimg'></span><img class='imgmain' src='"
							+ e.target.result
							+ "' width='100%' height='100%' /></div></div>");
					
					index++;
					
					$("#filesDiv").append(div);

				}
				
				
	        } 
		}
		
		/* 删除文件 */
		function delImg(th) {

			fileArr.splice($(th).attr("index"), 1);

			$(th).parent().parent().remove();

		}
		
		function eachCheckbox(){
			var num=0;
			$(".check").each(function(){
				if(this.checked){
					num++;
				}
			});
			if(num==0){
				return false;
			}else{
				return true;
			}
			
		}
		
		$(function() {
			vue.user = JSON.parse(window.localStorage.getItem("user"));
			$("#uid").val(vue.user.id);
			
			$.ajax({
				url:"querystore",
				data:"uid="+vue.user.id,
				type:"post",
				dataType:"json",
				success:function(result){
					vue.storeList=result;
				}
			});
			
			$("#add").click(function(){
				
				if($("#newsType").val()!=""){
					if(eachCheckbox()){
						if($("#notice").val()!=""){
							
							var formData=new FormData();
							for(var j = 0; j < fileArr.length;j++){
								formData.append("files",fileArr[j]);
							}
							var index=0;
							$(".check").each(function(i,o){
								if(this.checked){
									formData.append("clist["+index+"].id",$(o).next().val());
									index++;
								}
							});
							formData.append("nobj.nt",$("#newsType").val());
							formData.append("nobj.content",$("#notice").val());
							formData.append("nobj.uid",$("#uid").val());
							
							$.ajax({
								url:"addnews",
								type:"post",
								data:formData,
								processData:false,
								contentType:false,
								success:function(result){
									location.reload();
								}
							});
							
						}else{
							alert("请输入公告内容！");
						}
					}else{
						alert("请选择门店！");
					}
				}else{
					alert("请输入公告类型！");
				}
				
			
			});
			
		});
	</script>
</html>
